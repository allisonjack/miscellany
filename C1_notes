salloc -p short -N1 -t 01:00:00
#check squeue to see which node is allocated
#then log on to allocated node:
ssh -X nodeXXX

#interactive matlab
module load matlab
source ~/.bashrc

cd /lustre/groups/andi/GA_collab/C1_INPUT
module load fsl/gcc/5.0.7

#convert skull-stripped images to .nii
cat ASD_IDs.txt | while read ID; do
  mkdir -p ../SUIT/$ID
  fslchfiletype NIFTI $ID/anat_brain.nii.gz ../SUIT/$ID/anat_brain_suit.nii
done

cd ../SUIT

matlab &
spm fmri


#----JOB ARRAY-----
#save below as, e.g., prestats.sbatch

#-------------SBATCH FILE: prestats.sbatch---------#
#!/bin/bash

#SBATCH -J prestats_run1
#SBATCH -N1
#SBATCH -p defq
#SBATCH -t 02:00:00
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=allisonjack@gwu.edu
#SBATCH -o prestats_run1_%A_%a.out
#SBATCH -e prestats_run1_%A_%a.err

source ~/.bashrc

#mapfile only works on bash v. 4
#read text file lines into array "ID", origin at 1 and trailing newline removed
mapfile -O 1 -t ID < /lustre/groups/andi/GA_collab/SUIT/ASD_IDs.txt

module load fsl/gcc/5.0.7

#gets elements from the ID array using ${ID[X]}
#values for SLURM_ARRAY_TASK_ID are going to be passed into this script from sbatch call (--array option) at terminal 
feat /lustre/groups/andi/GA_collab/FSFs/${ID[SLURM_ARRAY_TASK_ID]}/prestats_suit_run1.fsf

#------------END SBATCH FILE---------#

#-----CALL AT TERMINAL-------#

#array call needs to be length of array, i.e. length of text file (wc -l ASD_IDs.txt | awk '{print $1}')
sbatch --array=1-16 prestats.sbatch

